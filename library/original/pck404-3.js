SR=8000,
T=t/SR,
TAU=2*PI,
mtof=n=>440*2**((n-69)/12),

t||(db=[],di=0),

dl=(v,len=SR/2,fb=.75,mix=.8)=>(
  d=db[p=(di-len)&65535]||0,
  db[di++&65535]=v+d*fb,
  v*(1-mix)+d*mix
),

n1=
[[2,0],[2,4],[4,6],[6,1],[6,3.5],[6,5],[6,7.5],[7,2],[14,0],[14,0.75],[14,1.5],[14,4],[14,4.75],[14,5.5],[16,0.25],[16,1],[16,1.75],[16,4.25],[16,5],[16,5.75],[21,0.5],[21,1.25],[21,4.5],[21,5.25]]
,

n2=
[[6,0],[9,0.5],[9,5],[14,1],[14,4.5],[16,3],[18,4]]
,

n3=
[[2,6],[4,2],[4,7],[6,1.75],[6,5.5],[6,8],[7,1.5],[7,5],[9,0],[9,1],[9,4.5]]
,

n4=
[[2,0],[4,0.0625],[6,0.125],[6,0.9375],[7,0.25],[9,0.1875],[13,0.3125],[13,0.875],[14,0.375],[14,0.75],[16,0.4375],[16,0.8125],[18,0.5],[18,0.6875],[19,0.625],[21,0.5625]].map(n=>[n[0],n[1]+0.5])
,

m2=[[],n2,n2,n3],

seek=(t,notes,l=1)=>(t*2,notes
 .filter(n=>t>=n[1] && t<n[1]+l)),

fm=(
 t,
 f=220,
 vel=0.2,
 ratio=3,
 d=1
)=>f&&(
 ampEnv=vel*exp(-t*2.5/d),
 fmEnv=vel*exp(-t*1.8/d),
 v=sin(
  TAU*f*t+
  3*vel*fmEnv*sin(TAU*f*ratio*t)
 ),
 trem=1+0.12*sin(TAU*5*t),
 tanh(v*ampEnv*trem*2)
),

T1=T%8,
T2=T%16,

s=2*seek(T1,n1,2).reduce((n,c)=>n+=fm(T1-c[1],mtof(c[0]+62),0.08,2.597,0.68),0)

+1.2*seek(T2,m2[(T>>4)&3],3).reduce((n,c)=>n+=fm(T2-c[1],mtof(c[0]+74),0.125,3,1.2),0)

+0.7*fm(T%4,mtof([0,0,40,40,40,40,45,40][(T>>3)&7]),0.26,5,6)

+0.5*(T2>8)*dl(sin(TAU*(T-0.5)/2)*0.1*seek(T1,n4,1/16).reduce((n,c)=>n+=sin(TAU*T*mtof(62+c[0]))>0.2?1:-1,0))
